# Task 1.30

++++

## A document for the dataset

Dataset由3部分组成：

1. 从原始图像中所裁剪的cube
2. cube对应的逐像素label
3. 记录每一个结节以及对应的bbox的JSON文件

### 从原始图像中裁剪的cube

我们以Luna16数据集作为我们的目标数据集。每一个Luna16数据集的mhd文件都有一个对应的xml文件，该文件记录了这个mhd文件有没有结节，结节在哪里等一系列信息。

我们对xml文件中的结节进行以下筛选，选取符合以下标准的结节进行动作：

1. 取结节长与宽的最大值$h_{max},w_{max}$，并将其转化为毫米单位。要求$30>mean(h_{max},w_{max})>5$
2. 取被3个以及3个以上医生标出来的结节为我们的目标结节
3. 每一个结节都应该有完整的轮廓标注，不是仅一点就可以了。

经过以下筛选后，原来的2373个结节被筛选剩下740个结节，这740个结节都是符合要求，被3个以上医生标注过的。

注意，在我们的操作中，我们将图片像素进行归一化，首先将阈值收缩到[-1000,400]，其次将这个阈值进行归一化操作，使得其变为0-1的灰度值。

### 对每个cube生成逐像素的label

对每一个mhd图像，我们生成相同大小的图像作为对应的源标注，在该标注上标注轮廓，对多个医生所给出的轮廓一起标注。

然后我们对标注过的slice进行大水漫灌法填充孔洞（因为大水漫灌法取的是多个医生给出的轮廓的并，这样label一般会比较膨胀，我们在label周围进行2个像素的腐蚀，得到更贴近于原图像的label）

最后我们将图像resize到每个体素是1mm\*1mm\*1mm大小，同时对label也如此进行resize，得到标准图像与label。

对于每一个我们选出来的cube，我们在原图像中进行裁剪，首先找出cube的中心，其次对中心位置上下，左右，前后32像素的单位进行选取，生成一个64\*64\*64的小cube，将它平铺为8*8的方形图，最后生成一个512\*512的图片。

### 记录每一个cube对应的bbox

我们采用字典记录每一个cube在原图中的bbox，这样也同时记录了我们选取的那些nodule：

`mhd_id+_+nodule_id:zmin,zmax,ymin,ymax,xmin,xmax`

将其作为字典排列在一个json文件中就得到了我们需要的信息。

### 使用

在网络训练的时候，我们建议选取每一个64\*64\*64的cube的中点，找周围20个像素生成40\*40\*40的目标cube进行处理即可。这样基本只包含1个结节了。当然我们也可以用其它颜色的办法找出其它结节。（因为一个64*64*64cube很可能有多个结节，一般结节中心相差在32以内都会出现，这也可以通过json文件来进行选择。



## 1.30工作回顾

1.完成了网络设计

2.完成了数据库制作

明天需要测试网络，看看结果。

